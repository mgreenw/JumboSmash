/*
 *  get-db-schema.js
 *  Author: Max Greenwald
 *  Date: 11/1/18
 *
 *  Get the textual schema of all the tables in the database and print to stdout
 *
 */

/* eslint-disable no-console */

const { exec } = require('child_process');

const utils = require('../utils');
const db = require('../db');

const NODE_ENV = utils.getNodeEnv();

function getTableSchema(table) {
  return new Promise((resolve, reject) => {
    exec(`psql -U postgres -d jumbosmash -c "\\d+ ${table}"`, (err, stdout) => {
      if (err) reject(err);
      resolve(stdout);
    });
  });
}

async function main() {
  if (NODE_ENV !== 'development') {
    console.log('Only check db schema on development.');
    process.exit(1);
  }

  const tableResults = await db.query(`
    SELECT table_name FROM information_schema.tables
    WHERE table_schema = 'public'
  `);

  try {
    const schemas = await Promise.all(tableResults.rows.map((element) => {
      return getTableSchema(element.table_name);
    }));

    console.log('# Database Schema');
    console.log('_NOTE_: this file is autogenerated using `npm run get-db-schema`\n\n');

    schemas.forEach((schema) => {
      console.log('```');
      console.log(schema);
      console.log('```');
    });
  } catch (error) {
    process.exit(1);
  }
}

main();
